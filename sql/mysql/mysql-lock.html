<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Mysql жћЂ | DB-TUTORIAL</title>
    <meta name="generator" content="VuePress 1.6.0">
    <link rel="icon" href="/db-tutorial/favicon.ico">
    <meta name="description" content="ТЋ░ТЇ«т║ЊТЋЎуеІ">
    <link rel="preload" href="/db-tutorial/assets/css/0.styles.634a41a8.css" as="style"><link rel="preload" href="/db-tutorial/assets/js/app.f29cbebc.js" as="script"><link rel="preload" href="/db-tutorial/assets/js/4.af39a5fc.js" as="script"><link rel="preload" href="/db-tutorial/assets/js/61.c22d11d4.js" as="script"><link rel="preload" href="/db-tutorial/assets/js/5.0833ef28.js" as="script"><link rel="prefetch" href="/db-tutorial/assets/js/10.6b2ec097.js"><link rel="prefetch" href="/db-tutorial/assets/js/11.fe247a47.js"><link rel="prefetch" href="/db-tutorial/assets/js/12.e26c5b2b.js"><link rel="prefetch" href="/db-tutorial/assets/js/13.2ea5597a.js"><link rel="prefetch" href="/db-tutorial/assets/js/14.c4329e96.js"><link rel="prefetch" href="/db-tutorial/assets/js/15.abd00e69.js"><link rel="prefetch" href="/db-tutorial/assets/js/16.f2fb3266.js"><link rel="prefetch" href="/db-tutorial/assets/js/17.ca8c65ee.js"><link rel="prefetch" href="/db-tutorial/assets/js/18.e65a545a.js"><link rel="prefetch" href="/db-tutorial/assets/js/19.80ebef0a.js"><link rel="prefetch" href="/db-tutorial/assets/js/20.4f4377f5.js"><link rel="prefetch" href="/db-tutorial/assets/js/21.0983e68b.js"><link rel="prefetch" href="/db-tutorial/assets/js/22.22549083.js"><link rel="prefetch" href="/db-tutorial/assets/js/23.4cd8f92b.js"><link rel="prefetch" href="/db-tutorial/assets/js/24.e6a7e02c.js"><link rel="prefetch" href="/db-tutorial/assets/js/25.fc3242b3.js"><link rel="prefetch" href="/db-tutorial/assets/js/26.2b1e6a49.js"><link rel="prefetch" href="/db-tutorial/assets/js/27.e1993f74.js"><link rel="prefetch" href="/db-tutorial/assets/js/28.bd52979c.js"><link rel="prefetch" href="/db-tutorial/assets/js/29.3062fb0d.js"><link rel="prefetch" href="/db-tutorial/assets/js/30.cf6658ff.js"><link rel="prefetch" href="/db-tutorial/assets/js/31.579bfba3.js"><link rel="prefetch" href="/db-tutorial/assets/js/32.760e57b8.js"><link rel="prefetch" href="/db-tutorial/assets/js/33.6bacc202.js"><link rel="prefetch" href="/db-tutorial/assets/js/34.cf51b09b.js"><link rel="prefetch" href="/db-tutorial/assets/js/35.b5c3639e.js"><link rel="prefetch" href="/db-tutorial/assets/js/36.296d25a5.js"><link rel="prefetch" href="/db-tutorial/assets/js/37.273ae643.js"><link rel="prefetch" href="/db-tutorial/assets/js/38.cc9c86d4.js"><link rel="prefetch" href="/db-tutorial/assets/js/39.7ede2256.js"><link rel="prefetch" href="/db-tutorial/assets/js/40.24d223a3.js"><link rel="prefetch" href="/db-tutorial/assets/js/41.d258cb86.js"><link rel="prefetch" href="/db-tutorial/assets/js/42.ba081766.js"><link rel="prefetch" href="/db-tutorial/assets/js/43.725edc07.js"><link rel="prefetch" href="/db-tutorial/assets/js/44.b674669d.js"><link rel="prefetch" href="/db-tutorial/assets/js/45.8f1d6536.js"><link rel="prefetch" href="/db-tutorial/assets/js/46.6e80620c.js"><link rel="prefetch" href="/db-tutorial/assets/js/47.171574eb.js"><link rel="prefetch" href="/db-tutorial/assets/js/48.8e9f5f77.js"><link rel="prefetch" href="/db-tutorial/assets/js/49.be5d55cf.js"><link rel="prefetch" href="/db-tutorial/assets/js/50.47613447.js"><link rel="prefetch" href="/db-tutorial/assets/js/51.2d41393b.js"><link rel="prefetch" href="/db-tutorial/assets/js/52.fd1c4457.js"><link rel="prefetch" href="/db-tutorial/assets/js/53.4110063d.js"><link rel="prefetch" href="/db-tutorial/assets/js/54.605fb79c.js"><link rel="prefetch" href="/db-tutorial/assets/js/55.5e21fc50.js"><link rel="prefetch" href="/db-tutorial/assets/js/56.63d90acc.js"><link rel="prefetch" href="/db-tutorial/assets/js/57.e4e93067.js"><link rel="prefetch" href="/db-tutorial/assets/js/58.e78118bb.js"><link rel="prefetch" href="/db-tutorial/assets/js/59.d7cb0130.js"><link rel="prefetch" href="/db-tutorial/assets/js/6.278670fd.js"><link rel="prefetch" href="/db-tutorial/assets/js/60.a013e1eb.js"><link rel="prefetch" href="/db-tutorial/assets/js/62.f169c057.js"><link rel="prefetch" href="/db-tutorial/assets/js/63.70d5a041.js"><link rel="prefetch" href="/db-tutorial/assets/js/64.c4586b91.js"><link rel="prefetch" href="/db-tutorial/assets/js/65.7e7aec26.js"><link rel="prefetch" href="/db-tutorial/assets/js/66.ec0b0ee4.js"><link rel="prefetch" href="/db-tutorial/assets/js/67.dca67a56.js"><link rel="prefetch" href="/db-tutorial/assets/js/68.d16570b7.js"><link rel="prefetch" href="/db-tutorial/assets/js/69.67735e91.js"><link rel="prefetch" href="/db-tutorial/assets/js/7.a10910a7.js"><link rel="prefetch" href="/db-tutorial/assets/js/8.04e2e190.js"><link rel="prefetch" href="/db-tutorial/assets/js/9.cccc2c89.js"><link rel="prefetch" href="/db-tutorial/assets/js/vendors~flowchart.d81c2c68.js"><link rel="prefetch" href="/db-tutorial/assets/js/vendors~notification.4573acaf.js">
    <link rel="stylesheet" href="/db-tutorial/assets/css/0.styles.634a41a8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/db-tutorial/" class="home-link router-link-active"><img src="images/dunwu-logo-100.png" alt="DB-TUTORIAL" class="logo"> <span class="site-name can-hide">DB-TUTORIAL</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/db-tutorial/sql/" class="nav-link router-link-active">
  SQL
</a></div><div class="nav-item"><a href="/db-tutorial/nosql/" class="nav-link">
  NOSQL
</a></div><div class="nav-item"><a href="/db-tutorial/sql/mysql/" class="nav-link router-link-active">
  Mysql
</a></div><div class="nav-item"><a href="/db-tutorial/nosql/redis/" class="nav-link">
  Redis
</a></div><div class="nav-item"><a href="/db-tutorial/nosql/mongodb/" class="nav-link">
  MongoDB
</a></div><div class="nav-item"><a href="https://github.com/dunwu/blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ­Ъј» тЇџт«б
  <svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/dunwu/db-tutorial" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/db-tutorial/sql/" class="nav-link router-link-active">
  SQL
</a></div><div class="nav-item"><a href="/db-tutorial/nosql/" class="nav-link">
  NOSQL
</a></div><div class="nav-item"><a href="/db-tutorial/sql/mysql/" class="nav-link router-link-active">
  Mysql
</a></div><div class="nav-item"><a href="/db-tutorial/nosql/redis/" class="nav-link">
  Redis
</a></div><div class="nav-item"><a href="/db-tutorial/nosql/mongodb/" class="nav-link">
  MongoDB
</a></div><div class="nav-item"><a href="https://github.com/dunwu/blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ­Ъј» тЇџт«б
  <svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/dunwu/db-tutorial" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Mysql жћЂ</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/db-tutorial/sql/mysql/mysql-lock.html#СИђсђЂТѓ▓УДѓжћЂтњїС╣љУДѓжћЂ" class="sidebar-link">СИђсђЂТѓ▓УДѓжћЂтњїС╣љУДѓжћЂ</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/db-tutorial/sql/mysql/mysql-lock.html#С║їсђЂУАеу║ДжћЂтњїУАїу║ДжћЂ" class="sidebar-link">С║їсђЂУАеу║ДжћЂтњїУАїу║ДжћЂ</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/db-tutorial/sql/mysql/mysql-lock.html#СИЅсђЂУ»╗тєЎжћЂ" class="sidebar-link">СИЅсђЂУ»╗тєЎжћЂ</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/db-tutorial/sql/mysql/mysql-lock.html#тЏЏсђЂТёЈтљЉжћЂ" class="sidebar-link">тЏЏсђЂТёЈтљЉжћЂ</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/db-tutorial/sql/mysql/mysql-lock.html#С║ћсђЂmvcc" class="sidebar-link">С║ћсђЂMVCC</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/db-tutorial/sql/mysql/mysql-lock.html#mvcc-ТђЮТЃ│" class="sidebar-link">MVCC ТђЮТЃ│</a></li><li class="sidebar-sub-header"><a href="/db-tutorial/sql/mysql/mysql-lock.html#уЅѕТюгтЈи" class="sidebar-link">уЅѕТюгтЈи</a></li><li class="sidebar-sub-header"><a href="/db-tutorial/sql/mysql/mysql-lock.html#undo-ТЌЦт┐Ќ" class="sidebar-link">Undo ТЌЦт┐Ќ</a></li><li class="sidebar-sub-header"><a href="/db-tutorial/sql/mysql/mysql-lock.html#readview" class="sidebar-link">ReadView</a></li><li class="sidebar-sub-header"><a href="/db-tutorial/sql/mysql/mysql-lock.html#т┐ФуЁДУ»╗СИјтйЊтЅЇУ»╗" class="sidebar-link">т┐ФуЁДУ»╗СИјтйЊтЅЇУ»╗</a></li></ul></li><li><a href="/db-tutorial/sql/mysql/mysql-lock.html#тЁГсђЂnext-key-жћЂ" class="sidebar-link">тЁГсђЂNext-key жћЂ</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/db-tutorial/sql/mysql/mysql-lock.html#тЈѓУђЃУхёТќЎ" class="sidebar-link">тЈѓУђЃУхёТќЎ</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="mysql-жћЂ"><a href="#mysql-жћЂ" class="header-anchor">#</a> Mysql жћЂ</h1> <p><img src="http://dunwu.test.upcdn.net/snap/20200716064947.png" alt="img"></p> <ul><li><a href="#%E4%B8%80%E6%82%B2%E8%A7%82%E9%94%81%E5%92%8C%E4%B9%90%E8%A7%82%E9%94%81">СИђсђЂТѓ▓УДѓжћЂтњїС╣љУДѓжћЂ</a></li> <li><a href="#%E4%BA%8C%E8%A1%A8%E7%BA%A7%E9%94%81%E5%92%8C%E8%A1%8C%E7%BA%A7%E9%94%81">С║їсђЂУАеу║ДжћЂтњїУАїу║ДжћЂ</a></li> <li><a href="#%E4%B8%89%E8%AF%BB%E5%86%99%E9%94%81">СИЅсђЂУ»╗тєЎжћЂ</a></li> <li><a href="#%E5%9B%9B%E6%84%8F%E5%90%91%E9%94%81">тЏЏсђЂТёЈтљЉжћЂ</a></li> <li><a href="#%E4%BA%94mvcc">С║ћсђЂMVCC</a> <ul><li><a href="#mvcc-%E6%80%9D%E6%83%B3">MVCC ТђЮТЃ│</a></li> <li><a href="#%E7%89%88%E6%9C%AC%E5%8F%B7">уЅѕТюгтЈи</a></li> <li><a href="#undo-%E6%97%A5%E5%BF%97">Undo ТЌЦт┐Ќ</a></li> <li><a href="#readview">ReadView</a></li> <li><a href="#%E5%BF%AB%E7%85%A7%E8%AF%BB%E4%B8%8E%E5%BD%93%E5%89%8D%E8%AF%BB">т┐ФуЁДУ»╗СИјтйЊтЅЇУ»╗</a></li></ul></li> <li><a href="#%E5%85%ADnext-key-%E9%94%81">тЁГсђЂNext-key жћЂ</a></li> <li><a href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">тЈѓУђЃУхёТќЎ</a></li></ul> <h2 id="СИђсђЂТѓ▓УДѓжћЂтњїС╣љУДѓжћЂ"><a href="#СИђсђЂТѓ▓УДѓжћЂтњїС╣љУДѓжћЂ" class="header-anchor">#</a> СИђсђЂТѓ▓УДѓжћЂтњїС╣љУДѓжћЂ</h2> <p>уА«С┐ЮтюетцџСИфС║ІтіАтљїТЌХтГўтЈќТЋ░ТЇ«т║ЊСИГтљїСИђТЋ░ТЇ«ТЌХСИЇуа┤тЮЈС║ІтіАуџёжџћуд╗ТђДтњїу╗ЪСИђТђДС╗ЦтЈіТЋ░ТЇ«т║Њуџёу╗ЪСИђТђД№╝ї<strong>С╣љУДѓжћЂтњїТѓ▓УДѓжћЂТў»т╣ХтЈЉТјДтѕХСИ╗УдЂжЄЄућеуџёТіђТю»ТЅІТ«хсђѓ</strong></p> <ul><li><strong><code>Тѓ▓УДѓжћЂ</code></strong> - тЂЄт«џС╝џтЈЉућЪт╣ХтЈЉтє▓уфЂ№╝їт▒ЈУћйСИђтѕЄтЈ»УЃйУ┐ЮтЈЇТЋ░ТЇ«т«їТЋ┤ТђДуџёТЊЇСйю
<ul><li>тюеТЪЦУ»бт«їТЋ░ТЇ«уџёТЌХтђЎт░▒ТііС║ІтіАжћЂУхиТЮЦ№╝їуЏ┤тѕ░ТЈљС║цС║ІтіА№╝ѕ<code>COMMIT</code>№╝Ѕ</li> <li>т«ъуј░Тќ╣т╝Ј№╝џ<strong>Сй┐ућеТЋ░ТЇ«т║ЊСИГуџёжћЂТю║тѕХ</strong>сђѓ</li></ul></li> <li><strong><code>С╣љУДѓжћЂ</code></strong> - тЂЄУ«ЙСИЇС╝џтЈЉућЪт╣ХтЈЉтє▓уфЂ№╝їтЈфтюеТЈљС║цТЊЇСйюТЌХТБђТЪЦТў»тљдУ┐ЮтЈЇТЋ░ТЇ«т«їТЋ┤ТђДсђѓ
<ul><li>тюеС┐«Тћ╣ТЋ░ТЇ«уџёТЌХтђЎТііС║ІтіАжћЂУхиТЮЦ№╝їжђџУ┐Є version уџёТќ╣т╝ЈТЮЦУ┐ЏУАїжћЂт«џ</li> <li>т«ъуј░Тќ╣т╝Ј№╝џ<strong>Сй┐уће version уЅѕТюгТѕќУђЁТЌХжЌ┤Тѕ│</strong>сђѓ</li></ul></li></ul> <p>сђљуц║СЙІсђЉС╣љУДѓжћЂуц║СЙІ</p> <p>тЋєтЊЂ goods УАеСИГТюЅСИђСИфтГЌТ«х status№╝їstatus СИ║ 1 С╗БУАетЋєтЊЂТюфУбФСИІтЇЋ№╝їstatus СИ║ 2 С╗БУАетЋєтЊЂти▓у╗ЈУбФСИІтЇЋ№╝їжѓБС╣ѕТѕЉС╗гт»╣ТЪљСИфтЋєтЊЂСИІтЇЋТЌХт┐ЁжА╗уА«С┐ЮУ»ЦтЋєтЊЂ status СИ║ 1сђѓтЂЄУ«ЙтЋєтЊЂуџё id СИ║ 1сђѓ</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token punctuation">(</span><span class="token keyword">status</span><span class="token punctuation">,</span><span class="token keyword">status</span><span class="token punctuation">,</span>version<span class="token punctuation">)</span> <span class="token keyword">from</span> t_goods <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token comment">#{id}</span>

<span class="token keyword">update</span> t_goods
<span class="token keyword">set</span> <span class="token keyword">status</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>version<span class="token operator">=</span>version<span class="token operator">+</span><span class="token number">1</span>
<span class="token keyword">where</span> id<span class="token operator">=</span><span class="token comment">#{id} and version=#{version};</span>
</code></pre></div><blockquote><p>ТЏ┤У»ду╗єуџёС╣љУДѓжћЂУ»┤тЈ»С╗ЦтЈѓУђЃ№╝џ<a href="https://www.cnblogs.com/laoyeye/p/8097684.html" target="_blank" rel="noopener noreferrer">Сй┐уће mysql С╣љУДѓжћЂУДБтє│т╣ХтЈЉжЌ«жбў<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <h2 id="С║їсђЂУАеу║ДжћЂтњїУАїу║ДжћЂ"><a href="#С║їсђЂУАеу║ДжћЂтњїУАїу║ДжћЂ" class="header-anchor">#</a> С║їсђЂУАеу║ДжћЂтњїУАїу║ДжћЂ</h2> <p>С╗јТЋ░ТЇ«т║ЊуџёжћЂу▓њт║дТЮЦуюІ№╝їMySQL СИГТЈљСЙЏС║єСИцуДЇт░ЂжћЂу▓њт║д№╝џУАїу║ДжћЂтњїУАеу║ДжћЂсђѓ</p> <ul><li><strong>УАеу║ДжћЂ№╝ѕtable lock№╝Ѕ</strong> - жћЂт«џТЋ┤т╝аУАесђѓућеТѕит»╣УАеУ┐ЏУАїтєЎТЊЇСйютЅЇ№╝їжюђУдЂтЁѕУјитЙЌтєЎжћЂ№╝їУ┐ЎС╝џжў╗тАътЁХС╗ќућеТѕит»╣У»ЦУАеуџёТЅђТюЅУ»╗тєЎТЊЇСйюсђѓтЈфТюЅТ▓АТюЅтєЎжћЂТЌХ№╝їтЁХС╗ќућеТѕиТЅЇУЃйУјитЙЌУ»╗жћЂ№╝їУ»╗жћЂС╣ІжЌ┤СИЇС╝џуЏИС║њжў╗тАъсђѓ</li> <li><strong>УАїу║ДжћЂ№╝ѕrow lock№╝Ѕ</strong> - жћЂт«џТїЄт«џуџёУАїУ«░тйЋсђѓУ┐ЎТаитЁХт«ЃУ┐ЏуеІУ┐ўТў»тЈ»С╗Цт»╣тљїСИђСИфУАеСИГуџётЁХт«ЃУ«░тйЋУ┐ЏУАїТЊЇСйюсђѓ</li></ul> <p>т║ћУ»Цт░йжЄЈтЈфжћЂт«џжюђУдЂС┐«Тћ╣уџёжѓБжЃетѕєТЋ░ТЇ«№╝їУђїСИЇТў»ТЅђТюЅуџёУхёТ║љсђѓ<strong>жћЂт«џуџёТЋ░ТЇ«жЄЈУХіт░Љ№╝їжћЂуФъС║ЅуџётЈЉућЪжбЉујЄт░▒УХіт░Ј№╝їу│╗у╗Ъуџёт╣ХтЈЉуеІт║дт░▒УХіжФў</strong>сђѓСйєТў»тіажћЂжюђУдЂТХѕУђЌУхёТ║љ№╝їжћЂуџётљёуДЇТЊЇСйю№╝ѕтїЁТІгУјитЈќжћЂсђЂжЄіТћЙжћЂсђЂС╗ЦтЈіТБђТЪЦжћЂуіХТђЂ№╝ЅжЃйС╝џтбътіау│╗у╗Ът╝ђжћђсђѓтЏаТГц<strong>жћЂу▓њт║дУХіт░Ј№╝їу│╗у╗Ът╝ђжћђт░▒УХітцД</strong>сђѓ</p> <p>тюежђЅТІЕжћЂу▓њт║дТЌХ№╝їжюђУдЂтюежћЂт╝ђжћђтњїт╣ХтЈЉуеІт║дС╣ІжЌ┤тЂџСИђСИфТЮЃУААсђѓ</p> <p>тюе <code>InnoDB</code> СИГ№╝ї<strong>УАїжћЂТў»жђџУ┐Єу╗Ўу┤бт╝ЋСИіуџёу┤бт╝ЋжА╣тіажћЂТЮЦт«ъуј░уџё</strong>сђѓ<strong>тдѓТъюТ▓АТюЅу┤бт╝Ћ№╝ї<code>InnoDB</code> т░єС╝џжђџУ┐ЄжџљУЌЈуџёУЂџу░Єу┤бт╝ЋТЮЦт»╣У«░тйЋтіажћЂ</strong>сђѓ</p> <h2 id="СИЅсђЂУ»╗тєЎжћЂ"><a href="#СИЅсђЂУ»╗тєЎжћЂ" class="header-anchor">#</a> СИЅсђЂУ»╗тєЎжћЂ</h2> <ul><li>уІгС║ФжћЂ№╝ѕExclusive№╝Ѕ№╝їу«ђтєЎСИ║ X жћЂ№╝їтЈѕуД░тєЎжћЂсђѓСй┐ућеТќ╣т╝Ј№╝џ<code>SELECT ... FOR UPDATE;</code></li> <li>тЁ▒С║ФжћЂ№╝ѕShared№╝Ѕ№╝їу«ђтєЎСИ║ S жћЂ№╝їтЈѕуД░У»╗жћЂсђѓСй┐ућеТќ╣т╝Ј№╝џ<code>SELECT ... LOCK IN SHARE MODE;</code></li></ul> <p>тєЎжћЂтњїУ»╗жћЂуџётЁ│у│╗№╝їу«ђУеђС╣І№╝џ<strong>уІгС║ФжћЂтГўтюе№╝їтЁХС╗ќС║ІтіАт░▒СИЇУЃйтЂџС╗╗СйЋТЊЇСйю</strong>сђѓ</p> <p><strong><code>InnoDB</code> СИІуџёУАїжћЂсђЂжЌ┤жџЎжћЂсђЂnext-key жћЂу╗Ъу╗Ът▒ъС║јуІгС║ФжћЂ</strong>сђѓ</p> <h2 id="тЏЏсђЂТёЈтљЉжћЂ"><a href="#тЏЏсђЂТёЈтљЉжћЂ" class="header-anchor">#</a> тЏЏсђЂТёЈтљЉжћЂ</h2> <p><strong>тйЊтГўтюеУАеу║ДжћЂтњїУАїу║ДжћЂуџёТЃЁтєхСИІ№╝їт┐ЁжА╗тЁѕућ│У»иТёЈтљЉжћЂ№╝ѕУАеу║ДжћЂ№╝їСйєСИЇТў»уюЪуџётіажћЂ№╝Ѕ№╝їтєЇУјитЈќУАїу║ДжћЂ</strong>сђѓСй┐ућеТёЈтљЉжћЂ№╝ѕIntention Locks№╝ЅтЈ»С╗ЦТЏ┤т«╣ТўЊтю░Тћ»ТїЂтцџу▓њт║дт░ЂжћЂсђѓ</p> <p><strong>ТёЈтљЉжћЂТў» <code>InnoDB</code> УЄфтіетіауџё№╝їСИЇжюђУдЂућеТѕит╣▓жбё</strong>сђѓ</p> <p>тюетГўтюеУАїу║ДжћЂтњїУАеу║ДжћЂуџёТЃЁтєхСИІ№╝їС║ІтіА T ТЃ│УдЂт»╣УАе A тіа X жћЂ№╝їт░▒жюђУдЂтЁѕТБђТхІТў»тљдТюЅтЁХт«ЃС║ІтіАт»╣УАе A ТѕќУђЁУАе A СИГуџёС╗╗ТёЈСИђУАїтіаС║єжћЂ№╝їжѓБС╣ѕт░▒жюђУдЂт»╣УАе A уџёТ»ЈСИђУАїжЃйТБђТхІСИђТгА№╝їУ┐ЎТў»жЮътИИУђЌТЌХуџёсђѓ</p> <p>ТёЈтљЉжћЂУДёт«џ№╝џ</p> <ul><li>IX/IS Тў»УАежћЂ№╝Џ</li> <li>X/S Тў»УАїжћЂсђѓ</li> <li>СИђСИфС║ІтіАтюеУјитЙЌТЪљСИфТЋ░ТЇ«УАїуџё S жћЂС╣ІтЅЇ№╝їт┐ЁжА╗тЁѕУјитЙЌУАеуџё IS жћЂТѕќУђЁТЏ┤т╝║уџёжћЂ№╝Џ</li> <li>СИђСИфС║ІтіАтюеУјитЙЌТЪљСИфТЋ░ТЇ«УАїуџё X жћЂС╣ІтЅЇ№╝їт┐ЁжА╗тЁѕУјитЙЌУАеуџё IX жћЂсђѓ</li></ul> <p>жђџУ┐Єт╝ЋтЁЦТёЈтљЉжћЂ№╝їС║ІтіА T ТЃ│УдЂт»╣УАе A тіа X жћЂ№╝їтЈфжюђУдЂтЁѕТБђТхІТў»тљдТюЅтЁХт«ЃС║ІтіАт»╣УАе A тіаС║є X/IX/S/IS жћЂ№╝їтдѓТъютіаС║єт░▒УАеуц║ТюЅтЁХт«ЃС║ІтіАТГБтюеСй┐ућеУ┐ЎСИфУАеТѕќУђЁУАеСИГТЪљСИђУАїуџёжћЂ№╝їтЏаТГцС║ІтіА T тіа X жћЂтц▒У┤Цсђѓ</p> <p>тљёуДЇжћЂуџётЁ╝т«╣тЁ│у│╗тдѓСИІ№╝џ</p> <table><thead><tr><th style="text-align:center;">-</th> <th style="text-align:center;">X</th> <th style="text-align:center;">IX</th> <th style="text-align:center;">S</th> <th style="text-align:center;">IS</th></tr></thead> <tbody><tr><td style="text-align:center;">X</td> <td style="text-align:center;">РЮї</td> <td style="text-align:center;">РЮї</td> <td style="text-align:center;">РЮї</td> <td style="text-align:center;">РЮї</td></tr> <tr><td style="text-align:center;">IX</td> <td style="text-align:center;">РЮї</td> <td style="text-align:center;">Рюћ№ИЈ</td> <td style="text-align:center;">РЮї</td> <td style="text-align:center;">Рюћ№ИЈ</td></tr> <tr><td style="text-align:center;">S</td> <td style="text-align:center;">РЮї</td> <td style="text-align:center;">РЮї</td> <td style="text-align:center;">Рюћ№ИЈ</td> <td style="text-align:center;">Рюћ№ИЈ</td></tr> <tr><td style="text-align:center;">IS</td> <td style="text-align:center;">РЮї</td> <td style="text-align:center;">Рюћ№ИЈ</td> <td style="text-align:center;">Рюћ№ИЈ</td> <td style="text-align:center;">Рюћ№ИЈ</td></tr></tbody></table> <p>УДБжЄітдѓСИІ№╝џ</p> <ul><li>С╗╗ТёЈ IS/IX жћЂС╣ІжЌ┤жЃйТў»тЁ╝т«╣уџё№╝їтЏаСИ║т«ЃС╗гтЈфУАеуц║ТЃ│УдЂт»╣УАетіажћЂ№╝їУђїСИЇТў»уюЪТГБтіажћЂ№╝Џ</li> <li>У┐ЎжЄїтЁ╝т«╣тЁ│у│╗жњѕт»╣уџёТў»УАеу║ДжћЂ№╝їУђїУАеу║Дуџё IX жћЂтњїУАїу║Дуџё X жћЂтЁ╝т«╣№╝їСИцСИфС║ІтіАтЈ»С╗Цт»╣СИцСИфТЋ░ТЇ«УАїтіа X жћЂсђѓ№╝ѕС║ІтіА T1 ТЃ│УдЂт»╣ТЋ░ТЇ«УАї R1 тіа X жћЂ№╝їС║ІтіА T2 ТЃ│УдЂт»╣тљїСИђСИфУАеуџёТЋ░ТЇ«УАї R2 тіа X жћЂ№╝їСИцСИфС║ІтіАжЃйжюђУдЂт»╣У»ЦУАетіа IX жћЂ№╝їСйєТў» IX жћЂТў»тЁ╝т«╣уџё№╝їт╣ХСИћ IX жћЂСИјУАїу║Дуџё X жћЂС╣ЪТў»тЁ╝т«╣уџё№╝їтЏаТГцСИцСИфС║ІтіАжЃйУЃйтіажћЂТѕљтіЪ№╝їт»╣тљїСИђСИфУАеСИГуџёСИцСИфТЋ░ТЇ«УАїтЂџС┐«Тћ╣сђѓ№╝Ѕ</li></ul> <h2 id="С║ћсђЂmvcc"><a href="#С║ћсђЂmvcc" class="header-anchor">#</a> С║ћсђЂMVCC</h2> <p><strong>тцџуЅѕТюгт╣ХтЈЉТјДтѕХ№╝ѕMulti-Version Concurrency Control, MVCC№╝ЅтЈ»С╗ЦУДєСИ║УАїу║ДжћЂуџёСИђСИфтЈўуДЇсђѓт«ЃтюетЙѕтцџТЃЁтєхСИІжЃйжЂ┐тЁЇС║єтіажћЂТЊЇСйю№╝їтЏаТГцт╝ђжћђТЏ┤Сйј</strong>сђѓСИЇС╗ЁТў» Mysql№╝їтїЁТІг OracleсђЂPostgreSQL уГЅтЁХС╗ќТЋ░ТЇ«т║ЊжЃйт«ъуј░С║єтљёУЄфуџё MVCC№╝їт«ъуј░Тю║тѕХТ▓АТюЅу╗ЪСИђТаЄтЄєсђѓ</p> <p>MVCC Тў» <code>InnoDB</code> тГўтѓет╝ЋТЊјт«ъуј░жџћуд╗у║ДтѕФуџёСИђуДЇтЁиСйЊТќ╣т╝Ј№╝ї<strong>ућеС║јт«ъуј░ТЈљС║цУ»╗тњїтЈ»жЄЇтцЇУ»╗У┐ЎСИцуДЇжџћуд╗у║ДтѕФ</strong>сђѓУђїТюфТЈљС║цУ»╗жџћуд╗у║ДтѕФТђ╗Тў»У»╗тЈќТюђТќ░уџёТЋ░ТЇ«УАї№╝їУдЂТ▒ѓтЙѕСйј№╝їТЌажюђСй┐уће MVCCсђѓтЈ»СИ▓УАїтїќжџћуд╗у║ДтѕФжюђУдЂт»╣ТЅђТюЅУ»╗тЈќуџёУАїжЃйтіажћЂ№╝їтЇЋу║»Сй┐уће MVCC ТЌаТ│Ћт«ъуј░сђѓ</p> <h3 id="mvcc-ТђЮТЃ│"><a href="#mvcc-ТђЮТЃ│" class="header-anchor">#</a> MVCC ТђЮТЃ│</h3> <p>тіажћЂУЃйУДБтє│тцџСИфС║ІтіАтљїТЌХТЅДУАїТЌХтЄ║уј░уџёт╣ХтЈЉСИђУЄ┤ТђДжЌ«жбўсђѓтюет«ъжЎЁтю║ТЎ»СИГУ»╗ТЊЇСйютЙђтЙђтцџС║јтєЎТЊЇСйю№╝їтЏаТГцтЈѕт╝ЋтЁЦС║єУ»╗тєЎжћЂТЮЦжЂ┐тЁЇСИЇт┐ЁУдЂуџётіажћЂТЊЇСйю№╝їСЙІтдѓУ»╗тњїУ»╗Т▓АТюЅС║њТќЦтЁ│у│╗сђѓУ»╗тєЎжћЂСИГУ»╗тњїтєЎТЊЇСйюС╗ЇуёХТў»С║њТќЦуџёсђѓ</p> <p>MVCC уџёТђЮТЃ│Тў»№╝џ</p> <ul><li><strong>С┐ЮтГўТЋ░ТЇ«тюеТЪљСИфТЌХжЌ┤уѓ╣уџёт┐ФуЁД№╝їтєЎТЊЇСйю№╝ѕDELETEсђЂINSERTсђЂUPDATE№╝ЅТЏ┤Тќ░ТюђТќ░уџёуЅѕТюгт┐ФуЁД№╝ЏУђїУ»╗ТЊЇСйютј╗У»╗ТЌДуЅѕТюгт┐ФуЁД№╝їТ▓АТюЅС║њТќЦтЁ│у│╗</strong>сђѓУ┐ЎСИђуѓ╣тњї <code>CopyOnWrite</code> у▒╗С╝╝сђѓ</li> <li>УёЈУ»╗тњїСИЇтЈ»жЄЇтцЇУ»╗ТюђТа╣ТюгуџётјЪтЏаТў»<strong>С║ІтіАУ»╗тЈќтѕ░тЁХт«ЃС║ІтіАТюфТЈљС║цуџёС┐«Тћ╣</strong>сђѓтюеС║ІтіАУ┐ЏУАїУ»╗тЈќТЊЇСйюТЌХ№╝їСИ║С║єУДБтє│УёЈУ»╗тњїСИЇтЈ»жЄЇтцЇУ»╗жЌ«жбў№╝ї<strong>MVCC УДёт«џтЈфУЃйУ»╗тЈќти▓у╗ЈТЈљС║цуџёт┐ФуЁД</strong>сђѓтйЊуёХСИђСИфС║ІтіАтЈ»С╗ЦУ»╗тЈќУЄфУ║ФТюфТЈљС║цуџёт┐ФуЁД№╝їУ┐ЎСИЇу«ЌТў»УёЈУ»╗сђѓ</li></ul> <h3 id="уЅѕТюгтЈи"><a href="#уЅѕТюгтЈи" class="header-anchor">#</a> уЅѕТюгтЈи</h3> <p>InnoDB уџё MVCC т«ъуј░Тў»№╝џтюеТ»ЈУАїУ«░тйЋтљјжЮбС┐ЮтГўСИцСИфжџљУЌЈтѕЌ№╝їСИђСИфтѕЌС┐ЮтГўУАїуџётѕЏт╗║ТЌХжЌ┤№╝їтЈдСИђСИфтѕЌС┐ЮтГўУАїуџёУ┐ЄТюЪТЌХжЌ┤№╝ѕУ┐ЎжЄїуџёТЌХжЌ┤Тў»ТїЄу│╗у╗ЪуЅѕТюгтЈи№╝ЅсђѓТ»Јт╝ђтДІСИђСИфТќ░С║ІтіА№╝їу│╗у╗ЪуЅѕТюгтЈиС╝џУЄфтіежђњтбъ№╝їС║ІтіАт╝ђтДІТЌХтѕ╗уџёу│╗у╗ЪуЅѕТюгтЈиС╝џСйюСИ║С║ІтіАуџёуЅѕТюгтЈи№╝їућеТЮЦтњїТЪЦУ»бтѕ░уџёТ»ЈУАїУ«░тйЋуџёуЅѕТюгтЈиУ┐ЏУАїТ»ћУЙЃсђѓ</p> <ul><li>у│╗у╗ЪуЅѕТюгтЈи <code>SYS_ID</code>№╝џТў»СИђСИфжђњтбъуџёТЋ░тГЌ№╝їТ»Јт╝ђтДІСИђСИфТќ░уџёС║ІтіА№╝їу│╗у╗ЪуЅѕТюгтЈит░▒С╝џУЄфтіежђњтбъсђѓ</li> <li>С║ІтіАуЅѕТюгтЈи <code>TRX_ID</code> №╝џС║ІтіАт╝ђтДІТЌХуџёу│╗у╗ЪуЅѕТюгтЈисђѓ</li></ul> <h3 id="undo-ТЌЦт┐Ќ"><a href="#undo-ТЌЦт┐Ќ" class="header-anchor">#</a> Undo ТЌЦт┐Ќ</h3> <p>MVCC уџётцџуЅѕТюгТїЄуџёТў»тцџСИфуЅѕТюгуџёт┐ФуЁД№╝їт┐ФуЁДтГўтѓетюе Undo ТЌЦт┐ЌСИГ№╝їУ»ЦТЌЦт┐ЌжђџУ┐ЄтЏъТ╗џТїЄжњѕ <code>ROLL_PTR</code> ТііСИђСИфТЋ░ТЇ«УАїуџёТЅђТюЅт┐ФуЁДУ┐ъТјЦУхиТЮЦсђѓ</p> <p>СЙІтдѓтюе MySQL тѕЏт╗║СИђСИфУАе t№╝їтїЁтљФСИ╗жћ« id тњїСИђСИфтГЌТ«х xсђѓТѕЉС╗гтЁѕТЈњтЁЦСИђСИфТЋ░ТЇ«УАї№╝їуёХтљјт»╣У»ЦТЋ░ТЇ«УАїТЅДУАїСИцТгАТЏ┤Тќ░ТЊЇСйюсђѓ</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t<span class="token punctuation">(</span>id<span class="token punctuation">,</span> x<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">UPDATE</span> t <span class="token keyword">SET</span> x<span class="token operator">=</span><span class="token string">&quot;b&quot;</span> <span class="token keyword">WHERE</span> id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">UPDATE</span> t <span class="token keyword">SET</span> x<span class="token operator">=</span><span class="token string">&quot;c&quot;</span> <span class="token keyword">WHERE</span> id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
</code></pre></div><p>тЏаСИ║Т▓АТюЅСй┐уће <code>START TRANSACTION</code> т░єСИіжЮбуџёТЊЇСйютйЊТѕљСИђСИфС║ІтіАТЮЦТЅДУАї№╝їТа╣ТЇ« MySQL уџё <code>AUTOCOMMIT</code> Тю║тѕХ№╝їТ»ЈСИфТЊЇСйюжЃйС╝џУбФтйЊТѕљСИђСИфС║ІтіАТЮЦТЅДУАї№╝їТЅђС╗ЦСИіжЮбуџёТЊЇСйюТђ╗тЁ▒ТХЅтЈітѕ░СИЅСИфС║ІтіАсђѓт┐ФуЁДСИГжЎцС║єУ«░тйЋС║ІтіАуЅѕТюгтЈи TRX_ID тњїТЊЇСйюС╣Ітцќ№╝їУ┐ўУ«░тйЋС║єСИђСИф bit уџё DEL тГЌТ«х№╝їућеС║јТаЄУ«░Тў»тљдУбФтѕажЎцсђѓ</p> <p><code>INSERT</code>сђЂ<code>UPDATE</code>сђЂ<code>DELETE</code> ТЊЇСйюС╝џтѕЏт╗║СИђСИфТЌЦт┐Ќ№╝їт╣Хт░єС║ІтіАуЅѕТюгтЈи <code>TRX_ID</code> тєЎтЁЦсђѓ<code>DELETE</code> тЈ»С╗ЦуюІТѕљТў»СИђСИфуЅ╣Т«іуџё <code>UPDATE</code>№╝їУ┐ўС╝џжбЮтцќт░є DEL тГЌТ«хУ«Йуй«СИ║ 1сђѓ</p> <h3 id="readview"><a href="#readview" class="header-anchor">#</a> ReadView</h3> <p>MVCC у╗┤ТіцС║єСИђСИфСИђУЄ┤ТђДУ»╗УДєтЏЙ <code>consistent read view</code> №╝їСИ╗УдЂтїЁтљФС║єтйЊтЅЇу│╗у╗Ъ<strong>ТюфТЈљС║цуџёС║ІтіАтѕЌУАе</strong> <code>TRX_IDs {TRX_ID_1, TRX_ID_2, ...}</code>№╝їУ┐ўТюЅУ»ЦтѕЌУАеуџёТюђт░Јтђ╝ <code>TRX_ID_MIN</code> тњї <code>TRX_ID_MAX</code>сђѓ</p> <p><img src="http://dunwu.test.upcdn.net/snap/20200715135809.png" alt="img"></p> <p>У┐ЎТаи№╝їт»╣С║јтйЊтЅЇС║ІтіАуџётљ»тіеуъгжЌ┤ТЮЦУ»┤№╝їСИђСИфТЋ░ТЇ«уЅѕТюгуџё row trx_id№╝їТюЅС╗ЦСИІтЄауДЇтЈ»УЃй№╝џ</p> <ol><li>тдѓТъюУљйтюеу╗┐УЅ▓жЃетѕє№╝їУАеуц║У┐ЎСИфуЅѕТюгТў»ти▓ТЈљС║цуџёС║ІтіАТѕќУђЁТў»тйЊтЅЇС║ІтіАУЄфти▒ућЪТѕљуџё№╝їУ┐ЎСИфТЋ░ТЇ«Тў»тЈ»УДЂуџё№╝Џ</li> <li>тдѓТъюУљйтюеу║бУЅ▓жЃетѕє№╝їУАеуц║У┐ЎСИфуЅѕТюгТў»ућ▒т░єТЮЦтљ»тіеуџёС║ІтіАућЪТѕљуџё№╝їТў»Уѓ»т«џСИЇтЈ»УДЂуџё№╝Џ</li> <li>тдѓТъюУљйтюеж╗ёУЅ▓жЃетѕє№╝їжѓБт░▒тїЁТІгСИцуДЇТЃЁтєх
a. УІЦ row trx_id тюеТЋ░у╗ёСИГ№╝їУАеуц║У┐ЎСИфуЅѕТюгТў»ућ▒У┐ўТ▓АТЈљС║цуџёС║ІтіАућЪТѕљуџё№╝їСИЇтЈ»УДЂ№╝Џ
b. УІЦ row trx_id СИЇтюеТЋ░у╗ёСИГ№╝їУАеуц║У┐ЎСИфуЅѕТюгТў»ти▓у╗ЈТЈљС║цС║єуџёС║ІтіАућЪТѕљуџё№╝їтЈ»УДЂсђѓ</li></ol> <p>тюеУ┐ЏУАї <code>SELECT</code> ТЊЇСйюТЌХ№╝їТа╣ТЇ«ТЋ░ТЇ«УАїт┐ФуЁДуџё <code>TRX_ID</code> СИј <code>TRX_ID_MIN</code> тњї <code>TRX_ID_MAX</code> С╣ІжЌ┤уџётЁ│у│╗№╝їС╗јУђїтѕцТќГТЋ░ТЇ«УАїт┐ФуЁДТў»тљдтЈ»С╗ЦСй┐уће№╝џ</p> <ul><li><code>TRX_ID</code> &lt; <code>TRX_ID_MIN</code>№╝їУАеуц║У»ЦТЋ░ТЇ«УАїт┐ФуЁДТЌХтюетйЊтЅЇТЅђТюЅТюфТЈљС║цС║ІтіАС╣ІтЅЇУ┐ЏУАїТЏ┤Тћ╣уџё№╝їтЏаТГцтЈ»С╗ЦСй┐ућесђѓ</li> <li><code>TRX_ID</code> &gt; <code>TRX_ID_MAX</code>№╝їУАеуц║У»ЦТЋ░ТЇ«УАїт┐ФуЁДТў»тюеС║ІтіАтљ»тіеС╣ІтљјУбФТЏ┤Тћ╣уџё№╝їтЏаТГцСИЇтЈ»Сй┐ућесђѓ</li> <li><code>TRX_ID_MIN</code> &lt;= <code>TRX_ID</code> &lt;= <code>TRX_ID_MAX</code>№╝їжюђУдЂТа╣ТЇ«жџћуд╗у║ДтѕФтєЇУ┐ЏУАїтѕцТќГ№╝џ
<ul><li>ТЈљС║цУ»╗№╝џтдѓТъю <code>TRX_ID</code> тюе <code>TRX_IDs</code> тѕЌУАеСИГ№╝їУАеуц║У»ЦТЋ░ТЇ«УАїт┐ФуЁДт»╣т║ћуџёС║ІтіАУ┐ўТюфТЈљС║ц№╝їтѕЎУ»Цт┐ФуЁДСИЇтЈ»Сй┐ућесђѓтљдтѕЎУАеуц║ти▓у╗ЈТЈљС║ц№╝їтЈ»С╗ЦСй┐ућесђѓ</li> <li>тЈ»жЄЇтцЇУ»╗№╝џжЃйСИЇтЈ»С╗ЦСй┐ућесђѓтЏаСИ║тдѓТъютЈ»С╗ЦСй┐ућеуџёУ»Ю№╝їжѓБС╣ѕтЁХт«ЃС║ІтіАС╣ЪтЈ»С╗ЦУ»╗тѕ░У┐ЎСИфТЋ░ТЇ«УАїт┐ФуЁДт╣ХУ┐ЏУАїС┐«Тћ╣№╝їжѓБС╣ѕтйЊтЅЇС║ІтіАтєЇтј╗У»╗У┐ЎСИфТЋ░ТЇ«УАїтЙЌтѕ░уџётђ╝т░▒С╝џтЈЉућЪТћ╣тЈў№╝їС╣Ът░▒Тў»тЄ║уј░С║єСИЇтЈ»жЄЇтцЇУ»╗жЌ«жбўсђѓ</li></ul></li></ul> <p>тюеТЋ░ТЇ«УАїт┐ФуЁДСИЇтЈ»Сй┐ућеуџёТЃЁтєхСИІ№╝їжюђУдЂТ▓┐уЮђ Undo Log уџётЏъТ╗џТїЄжњѕ ROLL_PTR ТЅЙтѕ░СИІСИђСИфт┐ФуЁД№╝їтєЇУ┐ЏУАїСИіжЮбуџётѕцТќГсђѓ</p> <h3 id="т┐ФуЁДУ»╗СИјтйЊтЅЇУ»╗"><a href="#т┐ФуЁДУ»╗СИјтйЊтЅЇУ»╗" class="header-anchor">#</a> т┐ФуЁДУ»╗СИјтйЊтЅЇУ»╗</h3> <p>т┐ФуЁДУ»╗</p> <p>MVCC уџё SELECT ТЊЇСйюТў»т┐ФуЁДСИГуџёТЋ░ТЇ«№╝їСИЇжюђУдЂУ┐ЏУАїтіажћЂТЊЇСйюсђѓ</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">table</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
</code></pre></div><p>тйЊтЅЇУ»╗</p> <p>MVCC тЁХт«ЃС╝џт»╣ТЋ░ТЇ«т║ЊУ┐ЏУАїС┐«Тћ╣уџёТЊЇСйю№╝ѕINSERTсђЂUPDATEсђЂDELETE№╝ЅжюђУдЂУ┐ЏУАїтіажћЂТЊЇСйю№╝їС╗јУђїУ»╗тЈќТюђТќ░уџёТЋ░ТЇ«сђѓтЈ»С╗ЦуюІтѕ░ MVCC т╣ХСИЇТў»т«їтЁеСИЇућетіажћЂ№╝їУђїтЈфТў»жЂ┐тЁЇС║є SELECT уџётіажћЂТЊЇСйюсђѓ</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">INSERT</span><span class="token punctuation">;</span>
<span class="token keyword">UPDATE</span><span class="token punctuation">;</span>
<span class="token keyword">DELETE</span><span class="token punctuation">;</span>
</code></pre></div><p>тюеУ┐ЏУАї SELECT ТЊЇСйюТЌХ№╝їтЈ»С╗Цт╝║тѕХТїЄт«џУ┐ЏУАїтіажћЂТЊЇСйюсђѓС╗ЦСИІуггСИђСИфУ»ГтЈЦжюђУдЂтіа S жћЂ№╝їуггС║їСИфжюђУдЂтіа X жћЂсђѓ</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">table</span> <span class="token keyword">WHERE</span> ? <span class="token keyword">lock</span> <span class="token operator">in</span> <span class="token keyword">share</span> <span class="token keyword">mode</span><span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">table</span> <span class="token keyword">WHERE</span> ? <span class="token keyword">for</span> <span class="token keyword">update</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="тЁГсђЂnext-key-жћЂ"><a href="#тЁГсђЂnext-key-жћЂ" class="header-anchor">#</a> тЁГсђЂNext-key жћЂ</h2> <p>Next-Key жћЂТў» MySQL уџё <code>InnoDB</code> тГўтѓет╝ЋТЊјуџёСИђуДЇжћЂт«ъуј░сђѓ</p> <p>MVCC СИЇУЃйУДБтє│т╣╗У»╗жЌ«жбў№╝ї<strong>Next-Key жћЂт░▒Тў»СИ║С║єУДБтє│т╣╗У»╗жЌ«жбў</strong>сђѓтюетЈ»жЄЇтцЇУ»╗№╝ѕ<code>REPEATABLE READ</code>№╝Ѕжџћуд╗у║ДтѕФСИІ№╝їСй┐уће <strong>MVCC + Next-Key жћЂ</strong> тЈ»С╗ЦУДБтє│т╣╗У»╗жЌ«жбўсђѓ</p> <p>тЈдтцќ№╝їТа╣ТЇ«жњѕт»╣ SQL У»ГтЈЦТБђу┤бТЮАС╗ХуџёСИЇтљї№╝їтіажћЂтЈѕТюЅС╗ЦСИІСИЅуДЇТЃЁтйбжюђУдЂТѕЉС╗гТјїТЈАсђѓ</p> <ul><li><code>Record Lock</code> - <strong>УАїжћЂт»╣у┤бт╝ЋжА╣тіажћЂ№╝їУІЦТ▓АТюЅу┤бт╝ЋтѕЎСй┐ућеУАежћЂ</strong>сђѓ</li> <li><code>Gap Lock</code> - т»╣у┤бт╝ЋжА╣С╣ІжЌ┤уџёжЌ┤жџЎтіажћЂсђѓжћЂт«џу┤бт╝ЋС╣ІжЌ┤уџёжЌ┤жџЎ№╝їСйєТў»СИЇтїЁтљФу┤бт╝ЋТюгУ║ФсђѓСЙІтдѓтйЊСИђСИфС║ІтіАТЅДУАїС╗ЦСИІУ»ГтЈЦ№╝їтЁХт«ЃС║ІтіАт░▒СИЇУЃйтюе t.c СИГТЈњтЁЦ 15сђѓ<code>SELECT c FROM t WHERE c BETWEEN 10 and 20 FOR UPDATE;</code></li> <li><code>Next-key lock</code> -т«ЃТў» <code>Record Lock</code> тњї <code>Gap Lock</code> уџёу╗Њтљѕ№╝їСИЇС╗ЁжћЂт«џСИђСИфУ«░тйЋСИіуџёу┤бт╝Ћ№╝їС╣ЪжћЂт«џу┤бт╝ЋС╣ІжЌ┤уџёжЌ┤жџЎсђѓт«ЃжћЂт«џСИђСИфтЅЇт╝ђтљјжЌГтї║жЌ┤сђѓ</li></ul> <p>у┤бт╝ЋтѕєСИ║СИ╗жћ«у┤бт╝ЋтњїжЮъСИ╗жћ«у┤бт╝ЋСИцуДЇ№╝їтдѓТъюСИђТЮА SQL У»ГтЈЦТЊЇСйюС║єСИ╗жћ«у┤бт╝Ћ№╝їMySQL т░▒С╝џжћЂт«џУ┐ЎТЮАСИ╗жћ«у┤бт╝Ћ№╝ЏтдѓТъюСИђТЮАУ»ГтЈЦТЊЇСйюС║єжЮъСИ╗жћ«у┤бт╝Ћ№╝їMySQL С╝џтЁѕжћЂт«џУ»ЦжЮъСИ╗жћ«у┤бт╝Ћ№╝їтєЇжћЂт«џуЏИтЁ│уџёСИ╗жћ«у┤бт╝Ћсђѓтюе <code>UPDATE</code>сђЂ<code>DELETE</code> ТЊЇСйюТЌХ№╝їMySQL СИЇС╗ЁжћЂт«џ <code>WHERE</code> ТЮАС╗ХТЅФТЈЈУ┐ЄуџёТЅђТюЅу┤бт╝ЋУ«░тйЋ№╝їУђїСИћС╝џжћЂт«џуЏИжѓ╗уџёжћ«тђ╝№╝їтЇ│ТЅђУ░Њуџё <code>next-key lock</code>сђѓ</p> <p>тйЊСИцСИфС║ІтіАтљїТЌХТЅДУАї№╝їСИђСИфжћЂСйЈС║єСИ╗жћ«у┤бт╝Ћ№╝їтюеуГЅтЙЁтЁХС╗ќуЏИтЁ│у┤бт╝ЋсђѓтЈдСИђСИфжћЂт«џС║єжЮъСИ╗жћ«у┤бт╝Ћ№╝їтюеуГЅтЙЁСИ╗жћ«у┤бт╝ЋсђѓУ┐ЎТаит░▒С╝џтЈЉућЪТГ╗жћЂсђѓтЈЉућЪТГ╗жћЂтљј№╝ї<code>InnoDB</code> СИђУѕгжЃйтЈ»С╗ЦТБђТхІтѕ░№╝їт╣ХСй┐СИђСИфС║ІтіАжЄіТћЙжћЂтЏъжђђ№╝їтЈдСИђСИфУјитЈќжћЂт«їТѕљС║ІтіАсђѓ</p> <h2 id="тЈѓУђЃУхёТќЎ"><a href="#тЈѓУђЃУхёТќЎ" class="header-anchor">#</a> тЈѓУђЃУхёТќЎ</h2> <ul><li><a href="https://book.douban.com/subject/23008813/" target="_blank" rel="noopener noreferrer">сђіжФўТђДУЃй MySQLсђІ<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/CyC2018/Interview-Notebook/blob/master/notes/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86.md" target="_blank" rel="noopener noreferrer">ТЋ░ТЇ«т║Њу│╗у╗ЪтјЪуљє<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://juejin.im/post/5b55b842f265da0f9e589e79" target="_blank" rel="noopener noreferrer">ТЋ░ТЇ«т║ЊСИцтцДуЦътЎесђљу┤бт╝ЋтњїжћЂсђЉ<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://www.cnblogs.com/laoyeye/p/8097684.html" target="_blank" rel="noopener noreferrer">Сй┐уће mysql С╣љУДѓжћЂУДБтє│т╣ХтЈЉжЌ«жбў<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/dunwu/db-tutorial/edit/master/docs/sql/mysql/mysql-lock.md" target="_blank" rel="noopener noreferrer">тИ«тіЕТѕЉС╗гТћ╣тќёТГцжАхжЮб№╝Ђ</a> <svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></footer> <!----> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/db-tutorial/assets/js/app.f29cbebc.js" defer></script><script src="/db-tutorial/assets/js/4.af39a5fc.js" defer></script><script src="/db-tutorial/assets/js/61.c22d11d4.js" defer></script><script src="/db-tutorial/assets/js/5.0833ef28.js" defer></script>
  </body>
</html>
